<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/JSONStream/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>

<span class="hljs-keyword">var</span> Parser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonparse'</span>)
  , through = <span class="hljs-built_in">require</span>(<span class="hljs-string">'through'</span>)

<span class="hljs-keyword">var</span> bufferFrom = Buffer.from &amp;&amp; Buffer.from !== <span class="hljs-built_in">Uint8Array</span>.from

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>the value of this.stack that creationix's jsonparse has is weird.</p>
</div>
<div class="body">
<p>it makes this code ugly, but his problem is way harder that mine,
so i'll forgive him.</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
exports.parse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path, map</span>) </span>{
  <span class="hljs-keyword">var</span> header, footer
  <span class="hljs-keyword">var</span> parser = <span class="hljs-keyword">new</span> Parser()
  <span class="hljs-keyword">var</span> stream = through(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> chunk)
      chunk = bufferFrom ? Buffer.from(chunk) : <span class="hljs-keyword">new</span> Buffer(chunk)
    parser.write(chunk)
  },
  <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">if</span>(data)
      stream.write(data)
    <span class="hljs-keyword">if</span> (header)
        stream.emit(<span class="hljs-string">'header'</span>, header)
    <span class="hljs-keyword">if</span> (footer)
      stream.emit(<span class="hljs-string">'footer'</span>, footer)
    stream.queue(<span class="hljs-literal">null</span>)
  })

  <span class="hljs-keyword">if</span>(<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> path)
    path = path.split(<span class="hljs-string">'.'</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
      <span class="hljs-keyword">if</span> (e === <span class="hljs-string">'$*'</span>)
        <span class="hljs-keyword">return</span> {<span class="hljs-attr">emitKey</span>: <span class="hljs-literal">true</span>}
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e === <span class="hljs-string">'*'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e === <span class="hljs-string">''</span>) <span class="hljs-comment">// '..'.split('.') returns an empty string</span>
        <span class="hljs-keyword">return</span> {<span class="hljs-attr">recurse</span>: <span class="hljs-literal">true</span>}
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> e
    })


  <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>, _key
  <span class="hljs-keyword">if</span>(!path || !path.length)
    path = <span class="hljs-literal">null</span>

  parser.onValue = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.root)
      stream.root = value

    <span class="hljs-keyword">if</span>(! path) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span> <span class="hljs-comment">// iterates on path</span>
    <span class="hljs-keyword">var</span> j  = <span class="hljs-number">0</span> <span class="hljs-comment">// iterates on stack</span>
    <span class="hljs-keyword">var</span> emitKey = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> emitPath = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">while</span> (i &lt; path.length) {
      <span class="hljs-keyword">var</span> key = path[i]
      <span class="hljs-keyword">var</span> c
      j++

      <span class="hljs-keyword">if</span> (key &amp;&amp; !key.recurse) {
        c = (j === <span class="hljs-keyword">this</span>.stack.length) ? <span class="hljs-keyword">this</span> : <span class="hljs-keyword">this</span>.stack[j]
        <span class="hljs-keyword">if</span> (!c) <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">if</span> (! check(key, c.key)) {
          setHeaderFooter(c.key, value)
          <span class="hljs-keyword">return</span>
        }
        emitKey = !!key.emitKey;
        emitPath = !!key.emitPath;
        i++
      } <span class="hljs-keyword">else</span> {
        i++
        <span class="hljs-keyword">var</span> nextKey = path[i]
        <span class="hljs-keyword">if</span> (! nextKey) <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
          c = (j === <span class="hljs-keyword">this</span>.stack.length) ? <span class="hljs-keyword">this</span> : <span class="hljs-keyword">this</span>.stack[j]
          <span class="hljs-keyword">if</span> (!c) <span class="hljs-keyword">return</span>
          <span class="hljs-keyword">if</span> (check(nextKey, c.key)) {
            i++;
            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Object</span>.isFrozen(<span class="hljs-keyword">this</span>.stack[j]))
              <span class="hljs-keyword">this</span>.stack[j].value = <span class="hljs-literal">null</span>
            <span class="hljs-keyword">break</span>
          } <span class="hljs-keyword">else</span> {
            setHeaderFooter(c.key, value)
          }
          j++
        }
      }

    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>emit header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (header) {
      stream.emit(<span class="hljs-string">'header'</span>, header);
      header = <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">if</span> (j !== <span class="hljs-keyword">this</span>.stack.length) <span class="hljs-keyword">return</span>

    count ++
    <span class="hljs-keyword">var</span> actualPath = <span class="hljs-keyword">this</span>.stack.slice(<span class="hljs-number">1</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element</span>) </span>{ <span class="hljs-keyword">return</span> element.key }).concat([<span class="hljs-keyword">this</span>.key])
    <span class="hljs-keyword">var</span> data = value
    <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> != data)
      <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> != (data = map ? map(data, actualPath) : data)) {
        <span class="hljs-keyword">if</span> (emitKey || emitPath) {
          data = { <span class="hljs-attr">value</span>: data };
          <span class="hljs-keyword">if</span> (emitKey)
            data[<span class="hljs-string">"key"</span>] = <span class="hljs-keyword">this</span>.key;
          <span class="hljs-keyword">if</span> (emitPath)
            data[<span class="hljs-string">"path"</span>] = actualPath;
        }

        stream.queue(data)
      }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.value) <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.value[<span class="hljs-keyword">this</span>.key]
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.stack)
      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Object</span>.isFrozen(<span class="hljs-keyword">this</span>.stack[k]))
        <span class="hljs-keyword">this</span>.stack[k].value = <span class="hljs-literal">null</span>
  }
  parser._onToken = parser.onToken;

  parser.onToken = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">token, value</span>) </span>{
    parser._onToken(token, value);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.stack.length === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (stream.root) {
        <span class="hljs-keyword">if</span>(!path)
          stream.queue(stream.root)
        count = <span class="hljs-number">0</span>;
        stream.root = <span class="hljs-literal">null</span>;
      }
    }
  }

  parser.onError = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span>(err.message.indexOf(<span class="hljs-string">"at position"</span>) &gt; <span class="hljs-number">-1</span>)
      err.message = <span class="hljs-string">"Invalid JSON ("</span> + err.message + <span class="hljs-string">")"</span>;
    stream.emit(<span class="hljs-string">'error'</span>, err)
  }

  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setHeaderFooter</span>(<span class="hljs-params">key, value</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>header has not been emitted yet</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (header !== <span class="hljs-literal">false</span>) {
      header = header || {}
      header[key] = value
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>footer has not been emitted yet but header has</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (footer !== <span class="hljs-literal">false</span> &amp;&amp; header === <span class="hljs-literal">false</span>) {
      footer = footer || {}
      footer[key] = value
    }
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span> (<span class="hljs-params">x, y</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> x)
    <span class="hljs-keyword">return</span> y == x
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x &amp;&amp; <span class="hljs-string">'function'</span> === <span class="hljs-keyword">typeof</span> x.exec)
    <span class="hljs-keyword">return</span> x.exec(y)
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'boolean'</span> === <span class="hljs-keyword">typeof</span> x || <span class="hljs-string">'object'</span> === <span class="hljs-keyword">typeof</span> x)
    <span class="hljs-keyword">return</span> x
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> === <span class="hljs-keyword">typeof</span> x)
    <span class="hljs-keyword">return</span> x(y)
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}

exports.stringify = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">op, sep, cl, indent</span>) </span>{
  indent = indent || <span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> (op === <span class="hljs-literal">false</span>){
    op = <span class="hljs-string">''</span>
    sep = <span class="hljs-string">'\n'</span>
    cl = <span class="hljs-string">''</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == <span class="hljs-literal">null</span>) {

    op = <span class="hljs-string">'[\n'</span>
    sep = <span class="hljs-string">'\n,\n'</span>
    cl = <span class="hljs-string">'\n]\n'</span>

  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>else, what ever you like</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">var</span> stream
    , first = <span class="hljs-literal">true</span>
    , anyData = <span class="hljs-literal">false</span>
  stream = through(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
    anyData = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">var</span> json = <span class="hljs-built_in">JSON</span>.stringify(data, <span class="hljs-literal">null</span>, indent)
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-keyword">return</span> stream.emit(<span class="hljs-string">'error'</span>, err)
    }
    <span class="hljs-keyword">if</span>(first) { first = <span class="hljs-literal">false</span> ; stream.queue(op + json)}
    <span class="hljs-keyword">else</span> stream.queue(sep + json)
  },
  <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">if</span>(!anyData)
      stream.queue(op)
    stream.queue(cl)
    stream.queue(<span class="hljs-literal">null</span>)
  })

  <span class="hljs-keyword">return</span> stream
}

exports.stringifyObject = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">op, sep, cl, indent</span>) </span>{
  indent = indent || <span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> (op === <span class="hljs-literal">false</span>){
    op = <span class="hljs-string">''</span>
    sep = <span class="hljs-string">'\n'</span>
    cl = <span class="hljs-string">''</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == <span class="hljs-literal">null</span>) {

    op = <span class="hljs-string">'{\n'</span>
    sep = <span class="hljs-string">'\n,\n'</span>
    cl = <span class="hljs-string">'\n}\n'</span>

  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>else, what ever you like</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">var</span> first = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">var</span> anyData = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> stream = through(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
    anyData = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">var</span> json = <span class="hljs-built_in">JSON</span>.stringify(data[<span class="hljs-number">0</span>]) + <span class="hljs-string">':'</span> + <span class="hljs-built_in">JSON</span>.stringify(data[<span class="hljs-number">1</span>], <span class="hljs-literal">null</span>, indent)
    <span class="hljs-keyword">if</span>(first) { first = <span class="hljs-literal">false</span> ; <span class="hljs-keyword">this</span>.queue(op + json)}
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.queue(sep + json)
  },
  <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">if</span>(!anyData) <span class="hljs-keyword">this</span>.queue(op)
    <span class="hljs-keyword">this</span>.queue(cl)

    <span class="hljs-keyword">this</span>.queue(<span class="hljs-literal">null</span>)
  })

  <span class="hljs-keyword">return</span> stream
}



</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
