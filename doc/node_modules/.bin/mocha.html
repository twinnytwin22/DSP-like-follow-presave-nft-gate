<!DOCTYPE html>
<html>
<head>
  <title>mocha</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/.bin/mocha";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>mocha</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>

<span class="hljs-meta">'use strict'</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>This wrapper executable checks for known node flags and appends them when found,
before invoking the &quot;real&quot; executable (<code>lib/cli/cli.js</code>)</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">const</span> {loadOptions} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/cli/options'</span>);
<span class="hljs-keyword">const</span> {
  unparseNodeFlags,
  isNodeFlag,
  impliesNoTimeouts
} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/cli/node-flags'</span>);
<span class="hljs-keyword">const</span> unparse = <span class="hljs-built_in">require</span>(<span class="hljs-string">'yargs-unparser'</span>);
<span class="hljs-keyword">const</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'mocha:cli:mocha'</span>);
<span class="hljs-keyword">const</span> {aliases} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/cli/run-option-metadata'</span>);

<span class="hljs-keyword">const</span> mochaArgs = {};
<span class="hljs-keyword">const</span> nodeArgs = {};
<span class="hljs-keyword">let</span> hasInspect = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">const</span> opts = loadOptions(process.argv.slice(<span class="hljs-number">2</span>));
debug(<span class="hljs-string">'loaded opts'</span>, opts);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Given option/command <code>value</code>, disable timeouts if applicable</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[value]</span>
<span class="dox_type">string</span>
<span><ul>
<li>Value to check</li>
</ul>
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> disableTimeouts = <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (impliesNoTimeouts(value)) {
    debug(<span class="hljs-string">'option %s disabled timeouts'</span>, value);
    mochaArgs.timeout = <span class="hljs-number">0</span>;
  }
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>If <code>value</code> begins with <code>v8-</code> and is not explicitly <code>v8-options</code>, remove prefix</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[value]</span>
<span class="dox_type">string</span>
<span><ul>
<li>Value to check</li>
</ul>
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> trimV8Option = <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span>
  value !== <span class="hljs-string">'v8-options'</span> &amp;&amp; <span class="hljs-regexp">/^v8-/</span>.test(value) ? value.slice(<span class="hljs-number">3</span>) : value;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>sort options into &quot;node&quot; and &quot;mocha&quot; buckets</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">Object</span>.keys(opts).forEach(<span class="hljs-function"><span class="hljs-params">opt</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (isNodeFlag(opt)) {
    nodeArgs[trimV8Option(opt)] = opts[opt];
  } <span class="hljs-keyword">else</span> {
    mochaArgs[opt] = opts[opt];
  }
});

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>disable 'timeout' for debugFlags</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">Object</span>.keys(nodeArgs).forEach(<span class="hljs-function"><span class="hljs-params">opt</span> =&gt;</span> disableTimeouts(opt));
mochaArgs[<span class="hljs-string">'node-option'</span>] &amp;&amp;
  mochaArgs[<span class="hljs-string">'node-option'</span>].forEach(<span class="hljs-function"><span class="hljs-params">opt</span> =&gt;</span> disableTimeouts(opt));

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Native debugger handling
see https://nodejs.org/api/debugger.html#debugger_debugger
look for 'inspect' that would launch this debugger,
remove it from Mocha's opts and prepend it to Node's opts.
A deprecation warning will be printed by node, if applicable.
(mochaArgs._ are &quot;positional&quot; arguments, not prefixed with - or --)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">if</span> (mochaArgs._) {
  <span class="hljs-keyword">const</span> i = mochaArgs._.findIndex(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> val === <span class="hljs-string">'inspect'</span>);
  <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">-1</span>) {
    mochaArgs._.splice(i, <span class="hljs-number">1</span>);
    disableTimeouts(<span class="hljs-string">'inspect'</span>);
    hasInspect = <span class="hljs-literal">true</span>;
  }
}

<span class="hljs-keyword">if</span> (mochaArgs[<span class="hljs-string">'node-option'</span>] || <span class="hljs-built_in">Object</span>.keys(nodeArgs).length || hasInspect) {
  <span class="hljs-keyword">const</span> {spawn} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);
  <span class="hljs-keyword">const</span> mochaPath = <span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">'../lib/cli/cli.js'</span>);

  <span class="hljs-keyword">const</span> nodeArgv =
    (mochaArgs[<span class="hljs-string">'node-option'</span>] &amp;&amp; mochaArgs[<span class="hljs-string">'node-option'</span>].map(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-string">'--'</span> + v)) ||
    unparseNodeFlags(nodeArgs);

  <span class="hljs-keyword">if</span> (hasInspect) nodeArgv.unshift(<span class="hljs-string">'inspect'</span>);
  <span class="hljs-keyword">delete</span> mochaArgs[<span class="hljs-string">'node-option'</span>];

  debug(<span class="hljs-string">'final node argv'</span>, nodeArgv);

  <span class="hljs-keyword">const</span> args = [].concat(
    nodeArgv,
    mochaPath,
    unparse(mochaArgs, {<span class="hljs-attr">alias</span>: aliases})
  );

  debug(
    <span class="hljs-string">'forking child process via command: %s %s'</span>,
    process.execPath,
    args.join(<span class="hljs-string">' '</span>)
  );

  <span class="hljs-keyword">const</span> proc = spawn(process.execPath, args, {
    <span class="hljs-attr">stdio</span>: <span class="hljs-string">'inherit'</span>
  });

  proc.on(<span class="hljs-string">'exit'</span>, (code, signal) =&gt; {
    process.on(<span class="hljs-string">'exit'</span>, () =&gt; {
      <span class="hljs-keyword">if</span> (signal) {
        process.kill(process.pid, signal);
      } <span class="hljs-keyword">else</span> {
        process.exit(code);
      }
    });
  });

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>terminate children.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  process.on(<span class="hljs-string">'SIGINT'</span>, () =&gt; {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>XXX: a previous comment said this would abort the runner, but I can't see that it does
anything with the default runner.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    debug(<span class="hljs-string">'main process caught SIGINT'</span>);
    proc.kill(<span class="hljs-string">'SIGINT'</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>if running in parallel mode, we will have a proper SIGINT handler, so the below won't
be needed.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (!args.parallel || args.jobs &lt; <span class="hljs-number">2</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>win32 does not support SIGTERM, so use next best thing.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>).platform() === <span class="hljs-string">'win32'</span>) {
        proc.kill(<span class="hljs-string">'SIGKILL'</span>);
      } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>using SIGKILL won't cleanly close the output streams, which can result
in cut-off text or a befouled terminal.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        debug(<span class="hljs-string">'sending SIGTERM to child process'</span>);
        proc.kill(<span class="hljs-string">'SIGTERM'</span>);
      }
    }
  });
} <span class="hljs-keyword">else</span> {
  debug(<span class="hljs-string">'running Mocha in-process'</span>);
  <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/cli/cli'</span>).main([], mochaArgs);
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
