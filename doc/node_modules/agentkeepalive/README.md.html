<!DOCTYPE html>
<html>
<head>
  <title>README.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/agentkeepalive/README.md";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#agentkeepalive">agentkeepalive</a>
      </div>

      <div class="heading h2">
        <a href="#whats-different-from-original-http.agent">What&#39;s different from original http.Agent?</a>
      </div>

      <div class="heading h2">
        <a href="#node.js-version-required">Node.js version required</a>
      </div>

      <div class="heading h2">
        <a href="#install">Install</a>
      </div>

      <div class="heading h2">
        <a href="#new-agent-options">new Agent([options])</a>
      </div>

      <div class="heading h2">
        <a href="#usage">Usage</a>
      </div>

      <div class="heading h3">
        <a href="#getter-agent.statuschanged">getter agent.statusChanged</a>
      </div>

      <div class="heading h3">
        <a href="#agent.getcurrentstatus">agent.getCurrentStatus()</a>
      </div>

      <div class="heading h3">
        <a href="#support-https">Support https</a>
      </div>

      <div class="heading h3">
        <a href="#support-req.reusedsocket">Support req.reusedSocket</a>
      </div>

      <div class="heading h2">
        <a href="#benchmark">Benchmark</a>
      </div>

      <div class="heading h2">
        <a href="#license">License</a>
      </div>

      <div class="heading h2">
        <a href="#contributors">Contributors</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="docs markdown"><div class="pilwrap" id="agentkeepalive">
  <h1>
    <a href="#agentkeepalive" name="agentkeepalive" class="pilcrow"></a>
agentkeepalive
  </h1>
</div>
<p><a href="https://npmjs.org/package/agentkeepalive"><img src="https://img.shields.io/npm/v/agentkeepalive.svg?style=flat" alt="NPM version"></a>
<a href="https://snyk.io/test/npm/agentkeepalive"><img src="https://snyk.io/test/npm/agentkeepalive/badge.svg?style=flat-square" alt="Known Vulnerabilities"></a>
<a href="https://github.com/node-modules/agentkeepalive/actions/workflows/nodejs.yml"><img src="https://github.com/node-modules/agentkeepalive/actions/workflows/nodejs.yml/badge.svg" alt="Node.js CI"></a>
<a href="https://npmjs.org/package/agentkeepalive"><img src="https://img.shields.io/npm/dm/agentkeepalive.svg?style=flat-square" alt="npm download"></a></p>
<p>The enhancement features <code>keep alive</code> <code>http.Agent</code>. Support <code>http</code> and <code>https</code>.</p>
<div class="pilwrap" id="whats-different-from-original-http.agent">
  <h2>
    <a href="#whats-different-from-original-http.agent" name="whats-different-from-original-http.agent" class="pilcrow"></a>
What's different from original <code>http.Agent</code>?
  </h2>
</div>
<ul>
<li><code>keepAlive=true</code> by default</li>
<li>Disable Nagle's algorithm: <code>socket.setNoDelay(true)</code></li>
<li>Add free socket timeout: avoid long time inactivity socket leak in the free-sockets queue.</li>
<li>Add active socket timeout: avoid long time inactivity socket leak in the active-sockets queue.</li>
<li>TTL for active socket.</li>
</ul>
<div class="pilwrap" id="node.js-version-required">
  <h2>
    <a href="#node.js-version-required" name="node.js-version-required" class="pilcrow"></a>
Node.js version required
  </h2>
</div>
<p>Support Node.js &gt;= <code>8.0.0</code></p>
<div class="pilwrap" id="install">
  <h2>
    <a href="#install" name="install" class="pilcrow"></a>
Install
  </h2>
</div>
<pre><code class="bash">$ npm install agentkeepalive --save
</code></pre>
<div class="pilwrap" id="new-agent-options">
  <h2>
    <a href="#new-agent-options" name="new-agent-options" class="pilcrow"></a>
new Agent([options])
  </h2>
</div>
<ul>
<li><code>options</code> {Object} Set of configurable options to set on the agent.
Can have the following fields:
<ul>
<li><code>keepAlive</code> {Boolean} Keep sockets around in a pool to be used by
other requests in the future. Default = <code>true</code>.</li>
<li><code>keepAliveMsecs</code> {Number} When using the keepAlive option, specifies the initial delay
for TCP Keep-Alive packets. Ignored when the keepAlive option is false or undefined. Defaults to 1000.
Default = <code>1000</code>.  Only relevant if <code>keepAlive</code> is set to <code>true</code>.</li>
<li><code>freeSocketTimeout</code>: {Number} Sets the free socket to timeout
after <code>freeSocketTimeout</code> milliseconds of inactivity on the free socket.
The default <a href="https://nodejs.org/api/http.html#serverkeepalivetimeout">server-side timeout</a> is 5000 milliseconds, to <a href="https://medium.com/ssense-tech/reduce-networking-errors-in-nodejs-23b4eb9f2d83">avoid ECONNRESET exceptions</a>, we set the default value to <code>4000</code> milliseconds.
Only relevant if <code>keepAlive</code> is set to <code>true</code>.</li>
<li><code>timeout</code>: {Number} Sets the working socket to timeout
after <code>timeout</code> milliseconds of inactivity on the working socket.
Default is <code>freeSocketTimeout * 2</code> so long as that value is greater than or equal to 8 seconds, otherwise the default is 8 seconds.</li>
<li><code>maxSockets</code> {Number} Maximum number of sockets to allow per
host. Default = <code>Infinity</code>.</li>
<li><code>maxFreeSockets</code> {Number} Maximum number of sockets (per host) to leave open
in a free state. Only relevant if <code>keepAlive</code> is set to <code>true</code>.
Default = <code>256</code>.</li>
<li><code>socketActiveTTL</code> {Number} Sets the socket active time to live, even if it's in use.
If not set, the behaviour keeps the same (the socket will be released only when free)
Default = <code>null</code>.</li>
</ul>
</li>
</ul>
<div class="pilwrap" id="usage">
  <h2>
    <a href="#usage" name="usage" class="pilcrow"></a>
Usage
  </h2>
</div>
<pre><code class="js"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">const</span> Agent = <span class="hljs-built_in">require</span>(<span class="hljs-string">'agentkeepalive'</span>);

<span class="hljs-keyword">const</span> keepaliveAgent = <span class="hljs-keyword">new</span> Agent({
  <span class="hljs-attr">maxSockets</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">maxFreeSockets</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">60000</span>, <span class="hljs-comment">// active socket keepalive for 60 seconds</span>
  <span class="hljs-attr">freeSocketTimeout</span>: <span class="hljs-number">30000</span>, <span class="hljs-comment">// free socket keepalive for 30 seconds</span>
});

<span class="hljs-keyword">const</span> options = {
  <span class="hljs-attr">host</span>: <span class="hljs-string">'cnodejs.org'</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-number">80</span>,
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  <span class="hljs-attr">agent</span>: keepaliveAgent,
};

<span class="hljs-keyword">const</span> req = http.request(options, res =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'STATUS: '</span> + res.statusCode);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'HEADERS: '</span> + <span class="hljs-built_in">JSON</span>.stringify(res.headers));
  res.setEncoding(<span class="hljs-string">'utf8'</span>);
  res.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'BODY: '</span> + chunk);
  });
});
req.on(<span class="hljs-string">'error'</span>, e =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'problem with request: '</span> + e.message);
});
req.end();

setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (keepaliveAgent.statusChanged) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'[%s] agent status changed: %j'</span>, <span class="hljs-built_in">Date</span>(), keepaliveAgent.getCurrentStatus());
  }
}, <span class="hljs-number">2000</span>);

</code></pre>
<div class="pilwrap" id="getter-agent.statuschanged">
  <h3>
    <a href="#getter-agent.statuschanged" name="getter-agent.statuschanged" class="pilcrow"></a>
<code>getter agent.statusChanged</code>
  </h3>
</div>
<p>counters have change or not after last checkpoint.</p>
<div class="pilwrap" id="agent.getcurrentstatus">
  <h3>
    <a href="#agent.getcurrentstatus" name="agent.getcurrentstatus" class="pilcrow"></a>
<code>agent.getCurrentStatus()</code>
  </h3>
</div>
<p><code>agent.getCurrentStatus()</code> will return a object to show the status of this agent:</p>
<pre><code class="js">{
  <span class="hljs-attr">createSocketCount</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">closeSocketCount</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">timeoutSocketCount</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">requestCount</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">freeSockets</span>: { <span class="hljs-string">'localhost:57479:'</span>: <span class="hljs-number">3</span> },
  <span class="hljs-attr">sockets</span>: { <span class="hljs-string">'localhost:57479:'</span>: <span class="hljs-number">5</span> },
  <span class="hljs-attr">requests</span>: {}
}
</code></pre>
<div class="pilwrap" id="support-https">
  <h3>
    <a href="#support-https" name="support-https" class="pilcrow"></a>
Support <code>https</code>
  </h3>
</div>
<pre><code class="js"><span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>);
<span class="hljs-keyword">const</span> HttpsAgent = <span class="hljs-built_in">require</span>(<span class="hljs-string">'agentkeepalive'</span>).HttpsAgent;

<span class="hljs-keyword">const</span> keepaliveAgent = <span class="hljs-keyword">new</span> HttpsAgent();
<span class="hljs-comment">// https://www.google.com/search?q=nodejs&amp;sugexp=chrome,mod=12&amp;sourceid=chrome&amp;ie=UTF-8</span>
<span class="hljs-keyword">const</span> options = {
  <span class="hljs-attr">host</span>: <span class="hljs-string">'www.google.com'</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-number">443</span>,
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/search?q=nodejs&amp;sugexp=chrome,mod=12&amp;sourceid=chrome&amp;ie=UTF-8'</span>,
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  <span class="hljs-attr">agent</span>: keepaliveAgent,
};

<span class="hljs-keyword">const</span> req = https.request(options, res =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'STATUS: '</span> + res.statusCode);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'HEADERS: '</span> + <span class="hljs-built_in">JSON</span>.stringify(res.headers));
  res.setEncoding(<span class="hljs-string">'utf8'</span>);
  res.on(<span class="hljs-string">'data'</span>, chunk =&gt; {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'BODY: '</span> + chunk);
  });
});

req.on(<span class="hljs-string">'error'</span>, e =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'problem with request: '</span> + e.message);
});
req.end();

setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'agent status: %j'</span>, keepaliveAgent.getCurrentStatus());
}, <span class="hljs-number">2000</span>);
</code></pre>
<div class="pilwrap" id="support-req.reusedsocket">
  <h3>
    <a href="#support-req.reusedsocket" name="support-req.reusedsocket" class="pilcrow"></a>
Support <code>req.reusedSocket</code>
  </h3>
</div>
<p>This agent implements the <code>req.reusedSocket</code> to determine whether a request is send through a reused socket.</p>
<p>When server closes connection at unfortunate time (<a href="https://code-examples.net/en/q/28a8069">keep-alive race</a>), the http client will throw a <code>ECONNRESET</code> error. Under this circumstance, <code>req.reusedSocket</code> is useful when we want to retry the request automatically.</p>
<pre><code class="js"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">const</span> Agent = <span class="hljs-built_in">require</span>(<span class="hljs-string">'agentkeepalive'</span>);
<span class="hljs-keyword">const</span> agent = <span class="hljs-keyword">new</span> Agent();

<span class="hljs-keyword">const</span> req = http
  .get(<span class="hljs-string">'http://localhost:3000'</span>, { agent }, (res) =&gt; {
    <span class="hljs-comment">// ...</span>
  })
  .on(<span class="hljs-string">'error'</span>, (err) =&gt; {
    <span class="hljs-keyword">if</span> (req.reusedSocket &amp;&amp; err.code === <span class="hljs-string">'ECONNRESET'</span>) {
      <span class="hljs-comment">// retry the request or anything else...</span>
    }
  })
</code></pre>
<p>This behavior is consistent with Node.js core. But through <code>agentkeepalive</code>, you can use this feature in older Node.js version.</p>
<div class="pilwrap" id="benchmark">
  <h2>
    <a href="#benchmark" name="benchmark" class="pilcrow"></a>
<a href="https://github.com/node-modules/agentkeepalive/tree/master/benchmark">Benchmark</a>
  </h2>
</div>
<p>run the benchmark:</p>
<pre><code class="bash"><span class="hljs-built_in">cd</span> benchmark
sh start.sh
</code></pre>
<p>Intel(R) Core(TM)2 Duo CPU     P8600  @ 2.40GHz</p>
<p>node@v0.8.9</p>
<p>50 maxSockets, 60 concurrent, 1000 requests per concurrent, 5ms delay</p>
<p>Keep alive agent (30 seconds):</p>
<pre><code class="js">Transactions:          <span class="hljs-number">60000</span> hits
<span class="hljs-attr">Availability</span>:         <span class="hljs-number">100.00</span> %
Elapsed time:          <span class="hljs-number">29.70</span> secs
Data transferred:        <span class="hljs-number">14.88</span> MB
Response time:            <span class="hljs-number">0.03</span> secs
Transaction rate:      <span class="hljs-number">2020.20</span> trans/sec
<span class="hljs-attr">Throughput</span>:           <span class="hljs-number">0.50</span> MB/sec
<span class="hljs-attr">Concurrency</span>:           <span class="hljs-number">59.84</span>
Successful transactions:       <span class="hljs-number">60000</span>
Failed transactions:             <span class="hljs-number">0</span>
Longest transaction:          <span class="hljs-number">0.15</span>
Shortest transaction:         <span class="hljs-number">0.01</span>
</code></pre>
<p>Normal agent:</p>
<pre><code class="js">Transactions:          <span class="hljs-number">60000</span> hits
<span class="hljs-attr">Availability</span>:         <span class="hljs-number">100.00</span> %
Elapsed time:          <span class="hljs-number">46.53</span> secs
Data transferred:        <span class="hljs-number">14.88</span> MB
Response time:            <span class="hljs-number">0.05</span> secs
Transaction rate:      <span class="hljs-number">1289.49</span> trans/sec
<span class="hljs-attr">Throughput</span>:           <span class="hljs-number">0.32</span> MB/sec
<span class="hljs-attr">Concurrency</span>:           <span class="hljs-number">59.81</span>
Successful transactions:       <span class="hljs-number">60000</span>
Failed transactions:             <span class="hljs-number">0</span>
Longest transaction:          <span class="hljs-number">0.45</span>
Shortest transaction:         <span class="hljs-number">0.00</span>
</code></pre>
<p>Socket created:</p>
<pre><code class="bash">[proxy.js:120000] keepalive, 50 created, 60000 requestFinished, 1200 req/socket, 0 requests, 0 sockets, 0 unusedSockets, 50 timeout
{<span class="hljs-string">" &lt;10ms"</span>:662,<span class="hljs-string">" &lt;15ms"</span>:17825,<span class="hljs-string">" &lt;20ms"</span>:20552,<span class="hljs-string">" &lt;30ms"</span>:17646,<span class="hljs-string">" &lt;40ms"</span>:2315,<span class="hljs-string">" &lt;50ms"</span>:567,<span class="hljs-string">" &lt;100ms"</span>:377,<span class="hljs-string">" &lt;150ms"</span>:56,<span class="hljs-string">" &lt;200ms"</span>:0,<span class="hljs-string">" &gt;=200ms+"</span>:0}
----------------------------------------------------------------
[proxy.js:120000] normal   , 53866 created, 84260 requestFinished, 1.56 req/socket, 0 requests, 0 sockets
{<span class="hljs-string">" &lt;10ms"</span>:75,<span class="hljs-string">" &lt;15ms"</span>:1112,<span class="hljs-string">" &lt;20ms"</span>:10947,<span class="hljs-string">" &lt;30ms"</span>:32130,<span class="hljs-string">" &lt;40ms"</span>:8228,<span class="hljs-string">" &lt;50ms"</span>:3002,<span class="hljs-string">" &lt;100ms"</span>:4274,<span class="hljs-string">" &lt;150ms"</span>:181,<span class="hljs-string">" &lt;200ms"</span>:18,<span class="hljs-string">" &gt;=200ms+"</span>:33}
</code></pre>
<div class="pilwrap" id="license">
  <h2>
    <a href="#license" name="license" class="pilcrow"></a>
License
  </h2>
</div>
<p><a href="LICENSE.html">MIT</a></p>
<div class="pilwrap" id="contributors">
  <h2>
    <a href="#contributors" name="contributors" class="pilcrow"></a>
Contributors
  </h2>
</div>
<p><a href="https://github.com/node-modules/agentkeepalive/graphs/contributors"><img src="https://ergatejs.implements.io/badges/contributors/node-modules/agentkeepalive.svg?size=96" alt=""></a></p>
</div>
  </div>
</body>
</html>
